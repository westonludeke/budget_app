<!DOCTYPE html>
<html lang="en">
<%- include('partials/_head.ejs') %>
<body>
<%- include('partials/_header.ejs') %>
  <main role="main" class="container mt-4">
    <h1 class="mb-4">Transactions</h1>
    <button id="saveChanges" class="btn btn-primary mb-3">Save Changes</button>
    <% console.log('Grouped transactions in view:', JSON.stringify(groupedTransactions, null, 2)); %>
    <% if (Object.keys(groupedTransactions).length > 0) { %>
      <% Object.keys(groupedTransactions).forEach(closeDate => { %>
        <div class="card mb-4" data-close-date="<%= closeDate %>">
          <div class="card-header">
            <h2 class="mb-0">Close Date: <%= closeDate %></h2>
            <p class="mb-0 transaction-count">Number of Transactions: <%= groupedTransactions[closeDate].count %></p>
            <p class="mb-0 transaction-total">Total Amount: $<%= groupedTransactions[closeDate].total.toFixed(2) %></p>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Post Date</th>
                    <th>Transaction Date</th>
                    <th>Reference Number</th>
                    <th>Merchant Data</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Close Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% groupedTransactions[closeDate].transactions.forEach(transaction => { %>
                    <% console.log('Rendering transaction:', JSON.stringify(transaction, null, 2)); %>
                    <tr data-id="<%= transaction._id %>">
                      <td><%= transaction.postDate.toLocaleDateString() %></td>
                      <td><%= transaction.transactionDate.toLocaleDateString() %></td>
                      <td><%= transaction.referenceNumber %></td>
                      <td><%= transaction.merchantData %></td>
                      <td>$<%= transaction.amount.toFixed(2) %></td>
                      <td>
                        <input type="text" class="form-control category"
                               data-id="<%= transaction._id %>"
                               value="<%= transaction.category || '' %>"
                               placeholder="Category">
                      </td>
                      <td>
                        <input type="text" class="form-control close-date"
                               data-id="<%= transaction._id %>"
                               value="<%= transaction.closeDate || '' %>"
                               placeholder="MM/YYYY">
                      </td>
                      <td>
                        <button class="btn btn-primary btn-sm edit-transaction" data-id="<%= transaction._id %>">Edit</button>
                        <button class="btn btn-danger btn-sm delete-transaction" data-id="<%= transaction._id %>">Delete</button>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% }); %>
      <!-- Pagination controls should be retained for overall navigation, even if not directly applicable to grouped view -->
      <nav aria-label="Transaction pagination">
        <ul class="pagination justify-content-center">
          <% for(let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= currentPage == i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>"><%= i %></a>
            </li>
          <% } %>
        </ul>
      </nav>
      <p class="text-center mt-3">
        Showing <%= totalTransactions %> transactions
      </p>
    <% } else { %>
      <p>No transactions found. Please upload a CSV file to see transactions.</p>
    <% } %>
  </main>
  <div id="editModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  <script src="/js/editTransaction.js"></script>
  <script src="/js/transactionUpdate.js"></script>
  <script src="/js/deleteTransaction.js"></script>
<%- include('partials/_footer.ejs') %>
</html>